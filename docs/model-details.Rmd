---
output:
  html_document:
    df_print: paged
    title: Model Details
  pdf_document: default
header-includes: \usepackage{amsmath}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(here)
library(tidyverse)
source("../covidhub-common.R")
#source(here::here("code/plotting/plotoverview.R"))
```

## Model of COVID-19 transmission in the U.S.A. by state
Updated `r format(Sys.time(), '%B %d, %Y')`

The epidemiology of COVID-19 is poorly understood.
To better understand the potential range of epidemic outcomes in the U.S.A., we developed a model based on the accumulation of knowledge from various locations and fit it to state-level observations of the number of reported cases, hospital admissions, and deaths.

### Data

#### Cases, Hospital Admissions, & Death Reports

Fitted data on incident case and death reports for each state in the U.S.A. were collated by the <a href="https://github.com/CSSEGISandData/COVID-19" target="_blank">COVID-19 Data Repository by the Center for Systems Science and Engineering (CSSE) at Johns Hopkins University"</a>.
Fitted data on hospital admissions were provided by the U.S. Department of Health & Human Services (HHS), which we accessed via the Delphi Epidata API [^1]. 
We show the state-level data here for California.


```{r read-data, fig.width=7}

forecast_date <- Sys.getenv("fdt", unset = "2021-04-12")
forecast_locs <- c("06") 

hopdir <- file.path("../hopkins", forecast_date)
tdat <- load_hopkins(hopdir, weekly = FALSE)
ltdat <- tdat %>% filter(location %in% forecast_locs) %>%
  filter(target_type == "day ahead inc case" |
           target_type == "day ahead inc death")
ltdat2 <-
  ltdat %>% mutate(time = lubridate::decimal_date(target_end_date)) %>%
  pivot_wider(names_from = target_type, values_from = value)

jhu_data <- ltdat2 %>% ungroup() %>%
  mutate(wday = lubridate::wday(target_end_date)) %>%
  rename(cases = `day ahead inc case`, deaths = `day ahead inc death`) %>%
  select(location, target_end_date, time, wday, cases, deaths)

load_healthd <- function(loc, dt) {
  healthd <-
    file.path("..", "healthdata", dt, loc, "epidata.csv")
  cov_thresh <- .9
  
  tdat2 <- read_csv(
    healthd,
    col_types = cols_only(
      date = col_date("%Y%m%d"),
      previous_day_admission_adult_covid_confirmed = col_integer(),
      previous_day_admission_pediatric_covid_confirmed = col_integer(),
      previous_day_admission_adult_covid_confirmed_coverage = col_integer()
    )
  )
  most_recent_coverage <- tdat2 %>%
    arrange(date) %>%
    pull(previous_day_admission_adult_covid_confirmed_coverage) %>%
    tail(n = 1)
  
  tdat3 <- tdat2 %>%
    filter(
      previous_day_admission_adult_covid_confirmed_coverage >
        most_recent_coverage * cov_thresh
    ) %>%
    filter(
      previous_day_admission_adult_covid_confirmed_coverage <
        most_recent_coverage / cov_thresh
    ) %>%
    mutate(
      hospitalizations = previous_day_admission_adult_covid_confirmed +
        previous_day_admission_pediatric_covid_confirmed,
      target_end_date = date - lubridate::ddays(1)
    ) %>%
    select(target_end_date, hospitalizations)
  tdat3
}

hd <- map(forecast_locs, load_healthd, dt = forecast_date)
names(hd) <- forecast_locs
hd1 <- bind_rows(hd, .id = "location")

obs_data <- left_join(jhu_data, hd1, by = c("target_end_date", "location"))

wind <- obs_data %>% filter(target_end_date >= "2020-03-02") %>%
  pivot_longer(c(cases, hospitalizations, deaths)) %>%
  mutate(state = covidcast::fips_to_name(paste0(location, "000")))

wind %>% ggplot(aes(x=target_end_date,  y = value)) + geom_col() + 
  facet_grid(name ~ state, scales = "free") + scale_y_log10() + 
  labs(x = "Date", y = "Count")

```

#### Social distancing / mobility data

To date, the primary interventions in all states have been vaccination and the adoption of social distancing behaviors and improved hygiene.
To quantify social distancing, we use indicators of aggregate behavior available from Google [^2].


These indicators are expressed as change from a baseline. A value of 0% indicates no change relative to the median value of the indicator from January 3 through February 6, 2020.

The rolling weekly average of the indicator of the duration of time spend in residential areas in California is shown below. 
We apply a rolling average because we do not attempt to model day-of-the-week effects of mobility on the transmission rate, and the original values of the metric are lowest on weekends due to the baseline being higher on weekends. 


```{r covariate, fig.height=3, fig.width=7, eval = TRUE}

sel_states <- forecast_locs %>% paste0("000") %>% covidcast::fips_to_name()

mob <- load_google_mobility("2021-05-06", rootdir = "..") %>%
  filter(sub_region_1 %in% sel_states) %>% group_by(sub_region_1) %>%
  mutate(rollmean = zoo::rollmean(residential_percent_change_from_baseline, k = 7, fill = NA)) %>% 
  mutate(residential = zoo::na.approx(rollmean, rule = 2))

mob %>% 
  ggplot(aes(x = date, y = residential)) + 
  geom_line() + facet_wrap(~sub_region_1) + 
  labs(y = "Percent increase in time spent\nin residential areas", x = "Date")

```

### Scenarios

We explore a range of scenarios for transmission.
Simulations in each state start on March 2, 2020.
The model is fit to data on reported cases, hospitalizations, and deaths available up to `r format(Sys.time(), '%B %d, %Y')` and propagated six weeks into the future.

*Possible futures scenarios*

We consider three possible futures scenarios. Our scenarios are all driven by changes in human mobility: increasing human mobility increases transmission rate, while decreasing mobility decreases transmission rate.
Our model includes a latent trend in transmission to account for all other factors that make transmission rate vary over time.
When projecting into the future, we use the most recent value of the fitted latent trend and use the naive forecast that it will stay the same in the next 6 weeks.

1. **Increasing social distancing.** Social distancing increases, increasing the current observed percent change from baseline to 30%, which is roughly the value of the metric in New York City at the time when the first wave of infection began to dissipate. 
Social distancing has the impact of reducing transmission rate. Thus, it is possible that other measures -- such as wide-spread, consistent wearing of face masks -- could achieve the same or similar level of transmission reduction that we model as an affect of social distancing.

2. **Maintain social distancing.** Social distancing continues at the last observed level of human movement patterns and the epidemic trajectory continues to follow it's most recent path, which is also influenced by the latent trend. 
Our model captures current increases in case/death reports by allowing transmission rate to increase either due to mobility or the fitted latent trend. 
Thus, even if mobility remains constant, the most recent increase in transmission causes the trajectory to increase in many cases. 
As during the beginning of the epidemic, such exponential growth can, and likely will be, averted by increase vigilance through social distancing and other practices that reduce transmission.

4. **Return to normal.** Social distancing returns to a level of human movement equivalent to baseline. 


### Model details

Key features of this model include:

* Stochastic transmission process with a realistic level of **random variation**.
* Realistic distributions of **presymptomatic and symptomatic periods**.
* Time varying **rates of case detection**
* **Day-of-the week effects on reporting** of cases and deaths.  
* Time varying **probability of a case being hospitalized**.  
* Accounting for the effect on transmission of **human mobility** (i.e., **social distancing**), as measured by data.
* A "latent" process that captures the effect of **environmental factors and other behaviors** that can reduce transmission but are difficult to quantify with data (e.g., hand washing or face masks).

The model comprises susceptible, presymptomatic, infectious, diagnosed, hospitalized and deceased persons. 
The following compartments are included:  

* $\boldsymbol{X}$ - Uninfected and *susceptible* individuals. Susceptible individuals can become infected by individuals in the $Y$ compartment.
* $\boldsymbol{L}$ - Individuals with *latent* infections who are not yet infectious. At the end of the $L$ stage, these individual progress to the $Y$ stage.
* $\boldsymbol{Y}$ - Individuals who are *infectious*. This compartment includes both symptomatic and asymptomatic individuals. 
* $\boldsymbol{Z}$ - Individuals who have been diagnosed and will be reported as *cases*, but have not yet been reported. Those individuals are likely isolated and so are not infectious in our model. This compartment includes a count for the fraction of infectious individuals who recover without hospitalization, and it includes all infectious individuals who enter the hospitalized class.
* $\boldsymbol{Z_r}$ - This compartment keeps track of the number of cases reported each day, which we can compare with official reports.
* $\boldsymbol{H}$ - Individuals who have been *hospitalized*. Those individuals are modeled as not infectious due to isolation. A fraction of individuals in the $H$ stage will recover, the remainder will die.
* $\boldsymbol{A}$ - *Admissions*. This compartment keeps track of the number of new hospitalized individuals each day, which we can compare with reported hospital admissions.
* $\boldsymbol{D}$ - Individuals who have *died* from the infection, but whose death has not yet been reported.
* $\boldsymbol{D_r}$ - The number of newly reported deaths each day.


The system of ordinary differential equations for the expected value of state variables in this model shown is:
\begin{align*}
\frac{dX(t)}{dt} =&  - \frac{\beta X\left( t \right) Y\left( t \right)}{N} \\
\frac{dY(t)}{dt} =& \eta L\left( t \right) - p_{h} \gamma Y\left( t \right) - \gamma \rho Y\left( t \right) \left( 1 - p_{h} \right) - \gamma Y\left( t \right) \left( 1 - p_{h} \right) \left( 1 - \rho \right) \\
\frac{dL(t)}{dt} =&  - \eta L\left( t \right) + \frac{\beta X\left( t \right) Y\left( t \right)}{N} \\
\frac{dZ(t)}{dt} =& p_{h} \gamma Y\left( t \right) - \gamma_{z} Z\left( t \right) + \gamma \rho Y\left( t \right) \left( 1 - p_{h} \right) \\
\frac{dZ_{r(t)}}{dt} =& \gamma_{z} Z\left( t \right) \\
\frac{dH(t)}{dt} =& p_{h} \gamma Y\left( t \right) - p_{d} \gamma_{h} H\left( t \right) - \gamma_{h} H\left( t \right) \left( 1 - p_{d} \right) \\
\frac{dA(t)}{dt} =& p_{h} \gamma Y\left( t \right) \\
\frac{dD(t)}{dt} =& p_{d} \gamma_{h} H\left( t \right) - \gamma_{d} D\left( t \right) \\
\frac{dD_{r(t)}}{dt} =& \gamma_{d} D\left( t \right)
\end{align*}


A diagram of the individual level reactions of our model is:
```{r pomp-model}
knitr::include_graphics(here::here("docs",'model2.png'))
```

#### Interventions

The following interventions are implemented:

* Social distancing is assumed to reduce all transmission rates by some factor. This is provided as a covariate based on mobility data.
* Improving detection, which is assumed to increase the fraction of individuals that move into the $Z$ compartment and will eventually be reported as cases. It is assume do increase with the relative increase of reported cases to deaths early in the epidemic.

#### Parameterization

Key parameters estimated using maximum likelihood by the [extended Kalman filter](https://en.wikipedia.org/wiki/Extended_Kalman_filter) include baseline transmissibility ($\beta_0$), the probability of a case leading to hospitalization, the effect of changes in mobility on the transmission rate, the fatality rate among hospitalized cases, and the initial size of the latent class. 
Auxiliary parameters estimated include the observation error of cases, deaths, and hospital admissions.

<small>**Disclaimer:** The COVID-19 epidemic is changing rapidly, and information that was used in the construction of this model may be incomplete or contain errors.
Accordingly, these results are preliminary, provisional, and subject to change.
These results have not been peer-reviewed, but have been prepared to a professional standard with the intention of providing useful interpretation of a rapidly developing event.</small>

[^1]:[Delphi Epidata API David C. Farrow, Logan C. Brooks, Aaron Rumack, Ryan J. Tibshirani, Roni Rosenfeld (2015). Delphi Epidata API.](https://github.com/cmu-delphi/delphi-epidata)

[^2]:[Google COVID-19 Community Mobility Reports.  Google LLC. Accessed: 2021-05-06.](https://www.google.com/covid19/mobility/)