---
output:
  html_document:
    df_print: paged
header-includes: \usepackage{amsmath}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(here)
library(tidyverse)
source("../covidhub-common.R")
#source(here::here("code/plotting/plotoverview.R"))
```

## Model of COVID-19 transmission in the U.S.A. by state
Updated `r format(Sys.time(), '%B %d, %Y')`

The epidemiology of COVID-19 is poorly understood.
To better understand the potential range of epidemic outcomes in the U.S.A., we developed a model based on the accumulation of knowledge from various locations and fit it to state-level observations of the number of reported cases, hospital admissions, and deaths.

### Data

#### Incident Case Data & Death Reports

Fitted data on incident case and death reports for each state in the U.S.A. were collated by the <a href="https://github.com/CSSEGISandData/COVID-19" target="_blank">COVID-19 Data Repository by the Center for Systems Science and Engineering (CSSE) at Johns Hopkins University"</a>.
Fitted data on hospital admissions were provided by the U.S. Department of Health & Human Services (HHS), which we accessed via the Delphi Epidata API [^1]. 
We show a subset of the state-level data here for Georgia, New York, Washington, and Wyoming.


```{r read-data, fig.width=7}

forecast_date <- Sys.getenv("fdt", unset = "2020-11-16")
forecast_locs <- c("13", "36", "53", "56") 

hopdir <- file.path("../hopkins", forecast_date)
tdat <- load_hopkins(hopdir, weekly = FALSE)
ltdat <- tdat %>% filter(location %in% forecast_locs) %>%
  filter(target_type == "day ahead inc case" |
           target_type == "day ahead inc death")
ltdat2 <-
  ltdat %>% mutate(time = lubridate::decimal_date(target_end_date)) %>%
  pivot_wider(names_from = target_type, values_from = value)

jhu_data <- ltdat2 %>% ungroup() %>%
  mutate(wday = lubridate::wday(target_end_date)) %>%
  rename(cases = `day ahead inc case`, deaths = `day ahead inc death`) %>%
  select(location, target_end_date, time, wday, cases, deaths)

load_healthd <- function(loc, dt) {
  healthd <-
    file.path("..", "healthdata", dt, loc, "epidata.csv")
  cov_thresh <- .9
  
  tdat2 <- read_csv(
    healthd,
    col_types = cols_only(
      date = col_date("%Y%m%d"),
      previous_day_admission_adult_covid_confirmed = col_integer(),
      previous_day_admission_pediatric_covid_confirmed = col_integer(),
      previous_day_admission_adult_covid_confirmed_coverage = col_integer()
    )
  )
  most_recent_coverage <- tdat2 %>%
    arrange(date) %>%
    pull(previous_day_admission_adult_covid_confirmed_coverage) %>%
    tail(n = 1)
  
  tdat3 <- tdat2 %>%
    filter(
      previous_day_admission_adult_covid_confirmed_coverage >
        most_recent_coverage * cov_thresh
    ) %>%
    filter(
      previous_day_admission_adult_covid_confirmed_coverage <
        most_recent_coverage / cov_thresh
    ) %>%
    mutate(
      hospitalizations = previous_day_admission_adult_covid_confirmed +
        previous_day_admission_pediatric_covid_confirmed,
      target_end_date = date - lubridate::ddays(1)
    ) %>%
    select(target_end_date, hospitalizations)
  tdat3
}

hd <- map(forecast_locs, load_healthd, dt = forecast_date)
names(hd) <- forecast_locs
hd1 <- bind_rows(hd, .id = "location")

obs_data <- left_join(jhu_data, hd1, by = c("target_end_date", "location"))

wind <- obs_data %>% filter(target_end_date >= "2020-03-02") %>%
  pivot_longer(c(cases, hospitalizations, deaths)) %>%
  mutate(state = covidcast::fips_to_name(paste0(location, "000")))

wind %>% ggplot(aes(x=target_end_date,  y = value)) + geom_col() + 
  facet_grid(name ~ state, scales = "free") + scale_y_log10() + 
  labs(x = "Date", y = "Count")

```

#### Social distancing / mobility data

To date, the primary interventions in all states have been vaccination and the adoption of social distancing behaviors and improved hygiene.
To quantify social distancing, we use indicators of aggregate behavior available from Google [^2].


These indicators are expressed as change from a baseline. A value of 0% indicates no change relative to the median value of the indicator from January 3 through February 6, 2020.

The indicator of the duration of time spend in residential areas in our 4 focal states is shown below.

```{r covariate, fig.height=3, fig.width=7, eval = TRUE}

sel_states <- forecast_locs %>% paste0("000") %>% covidcast::fips_to_name()

mob <- load_google_mobility("2021-05-06", rootdir = "..") %>%
  filter(sub_region_1 %in% sel_states)

mob %>% 
  ggplot(aes(x = date, y = residential_percent_change_from_baseline)) + 
  geom_line() + facet_wrap(~sub_region_1) + 
  labs(y = "Time spent in residential areas", x = "Date")

```

### Scenarios

We explore a range of scenarios for transmission.
Simulations in each state start on the data on which at least 1 case was first reported.
The model is fit to data on reported cases and deaths to `r format(Sys.time(), '%B %d, %Y')` and propagated six weeks into the future.

*Possible futures scenarios*

We consider three possible futures scenarios. Our scenarios are all driven by changes in human mobility: increasing human mobility increases transmission rate, while decreasing mobility decreases transmission rate.
Our model includes a latent trend in transmission to account for all other factors that make transmission rate vary over time.
When projecting into the future, we extract the fitted latent trend effect over the last 30 days and then take the mean over the first 20 days of that 30 day period.
We ignore the last 10 days to avoid undue influence of the latent trend as it adapts to fit the most recent data.

1. **Increasing social distancing.** Social distancing increases, reducing movements from the current observed level to 30% of normal, which is the reduction observed in New York City that enabled transmission to decline there. Social distancing has the impact of reducing transmission rate. Thus, it is possible that other measures -- such as wide-spread, consistent wearing of face masks -- could achieve the same or similar level of transmission reduction that we model as an affect of social distancing.

2. **Maintain social distancing.** Social distancing continues at the last observed level of human movement patterns and the epidemic trajectory continues to follow it's most recent path, which is also influenced by the latent trend. Our model captures current increases in case/death reports by allowing transmission rate to increase either due to mobility or the fitted latent trend. Thus, even if mobility remains constant, the most recent increase in transmission causes the trajectory to increase in many cases. As during the beginning of the epidemic, such exponential growth can, and likely will be, averted by increase vigilance through social distancing and other practices that reduce transmission.

4. **Return to normal.** Social distancing returns to a level of human movement equivalent to baseline. 


### Model details

Key features of this model include:

* Stochastic transmission process with a realistic level of **random variation**.
* Realistic distributions of **presymptomatic and symptomatic periods**.
* Different **transmission rates for asymptomatic, presymptomatic, and symptomatic individuals**.[^1]
* Time varying **rates of case detection, isolation, and case notification**.  
* Time varying **mortality**.  
* Accounting for the effect on transmission of **human mobility** (i.e., **social distancing**), as measured by data.
* A "latent" process that captures the effect of **environmental factors and other behaviors** that can reduce transmission but are difficult to quantify with data (e.g., hand washing or face masks).
* Realistic intervention scenarios (e.g. improving case detection, faster testing).

The model comprises susceptible, presymptomatic, asymptomatic, symptomatic, diagnosed, hospitalized, deceased, and recovered persons. 
The following compartments are included:  

* $\boldsymbol{S}$ - Uninfected and *susceptible* individuals. Susceptible individuals can become infected by individuals in the $L$, $I_a$, $I_{su}$, $I_{sd}$, $C$, and $H$ stages. Rates of transmission from these stages can be adjusted individually.
* $\boldsymbol{L}$ - Individuals with *latent* infections who do not yet show symptoms. Those individuals can be infectious. At the end of the $L$ stage, a fraction moves into the $I_a$ stage, another fraction moves into the $I_{su}$ stage, and the remainder into the $I_{sd}$ stage.
* $\boldsymbol{I_a}$ - Individuals who are *infected* and *asymptomatic*. Those individuals are likely infectious, but the model allows to adjust this.
* $\boldsymbol{I_{su}}$ - Individuals who are *infected* and *symptomatic*, but are *undetected*. Those individuals are likely infectious. Individuals in this compartment never get diagnosed, and are assumed to recover.
* $\boldsymbol{I_{sd}}$ - Individuals who are *infected* and *symptomatic*, and are *detected*. Those individuals are likely infectious. Individuals in this compartment will be diagnosed and move to $C$.
* $\boldsymbol{C}$ - Individuals who have been diagnosed as *cases*. Those individuals are likely isolated and not infectious, but the model allows to adjust this. A fraction of individuals in the $C$ stage will naturally recover, without the need for hospitalization. The remainder moves into the $H$ stage.
* $\boldsymbol{H}$ - Individuals who have been *hospitalized*. Those individuals are likely isolated and not infectious, but the model allows to adjust this. A fraction of individuals in the $H$ stage will recover, the remainder will die.
* $\boldsymbol{R}$ - *Recovered/removed* individuals. Those individuals have recovered and are immune. 
* $\boldsymbol{D}$ - Individuals who *died* from the infection. 

To allow more realistic distributions of movement through compartments, several of these compartments are internally split into multiple stages using the *linear chain trick*.[^2]

* $\boldsymbol{L}$ - 4 compartments
* $\boldsymbol{I_a}$ - 4 compartments 
* $\boldsymbol{I_{su}}$ - 4 compartments
* $\boldsymbol{I_{sd}}$ - 4 compartments
* $\boldsymbol{C}$ - 4 compartments
* $\boldsymbol{H}$ - 4 compartments

The flow diagram for this model shown below.

```{r pomp-model}
knitr::include_graphics(here::here("docs",'pomp-model.png'))
```

#### Interventions

The following interventions are implemented:

* Social distancing is assumed to reduce all transmission rates by some factor. This is provided as a covariate based on mobility data.
* Decreasing time to diagnosis, which speeds up the transition from the detected class (I_sd) to the diagnosed cases class (C).
* Improving detection, which is assumed to increase the fraction of symptomatic individuals that move into the $I_{sd}$ compartment and will eventually be diagnosed. It is assumed to increase sigmoidally up to a maximum value.

#### Parameterization

This model was initially parameterized using clinical outcome reports from the epidemic in Hubei province, China and further calibrated with information about COVID-19 elsewhere in China and the United States.
Transmissibility of the virus is assumed to be proportional to the level of human movement.

Key parameters estimated using maximum likelihood by iterated filtering (MIF)[^3] include baseline transmissibility ($\beta_0$), maximum ascertainment (i.e. maximum fraction of cases detected), fraction of known cases that are hospitalized, fatality rate among hospitalized cases, and the initial size of the latent class. 
Auxiliary parameters estimated using MIF include the intensity of the parameter random walk and dispersion parameters for observables.

<small>**Disclaimer:** The COVID-19 epidemic is changing rapidly, and information that was used in the construction of this model may be incomplete or contain errors.
Accordingly, these results are preliminary, provisional, and subject to change.
These results have not been peer-reviewed, but have been prepared to a professional standard with the intention of providing useful interpretation of a rapidly developing event.</small>



[^1]:[Delphi Epidata API](David C. Farrow, Logan C. Brooks, Aaron Rumack, Ryan J. Tibshirani, Roni Rosenfeld (2015). Delphi Epidata API. https://github.com/cmu-delphi/delphi-epidata)

[^2]: [Google COVID-19 Community Mobility Reports]. (Google LLC https://www.google.com/covid19/mobility/ Accessed: 2021-05-06.)



[^3]:[Rong et al. 2020](https://wwwnc.cdc.gov/eid/article/26/5/20-0198_article?deliveryName=DM20712), [Du et al. 2020](https://www.medrxiv.org/content/10.1101/2020.02.19.20025452v3)

[^4]:[Hurtado & Kirosingh 2019](https://link.springer.com/article/10.1007/s00285-019-01412-w)

[^5]:[Ionides et al. 2006](https://www.pnas.org/content/103/49/18438)



