name: update-pipeline-outputs
on:
  push:
    paths-ignore:
      - '.dvc/**'
      - dvc.lock
      - 'metrics/**'
      - README.md
    branches:
      - '!sir-kf'
      - '!master'
jobs: 
  run:
    runs-on: [ubuntu-latest]
    container: docker://eamon/sir-kf:2021-02-22
    steps:
      - uses: actions/checkout@v2
      - name: cml_run
        env:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          dvc pull --run-cache || true
          dvc repro
          dvc push
          
          git config --local user.email "actions@users.noreply.github.com"
          git config --local user.name "Automated Publisher"
          git add dvc.lock metrics
          if git commit -m "dvc repro autoupdate" && git push;
          then
            echo "Pushed changes." > report.md         
          else
            echo "No changes to outputs." > report.md
          fi
          cml-send-comment report.md
